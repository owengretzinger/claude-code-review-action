name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Setup MCP inline comment server
        env:
          APP_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          # Clone the action repo to get the MCP server with all dependencies
          git clone --depth 1 https://github.com/anthropics/claude-code-action.git /tmp/claude-code-action
          cd /tmp/claude-code-action

          # Install bun and dependencies
          npm install -g bun
          bun install

          # Create MCP config using echo to avoid YAML parsing issues with heredocs
          echo '{"mcpServers":{"github_inline_comment":{"command":"bun","args":["run","/tmp/claude-code-action/src/mcp/github-inline-comment-server.ts"],"env":{"GITHUB_TOKEN":"'"${APP_TOKEN}"'","REPO_OWNER":"'"${REPO_OWNER}"'","REPO_NAME":"'"${REPO_NAME}"'","PR_NUMBER":"'"${PR_NUM}"'","GITHUB_API_URL":"https://api.github.com"}}}}' > /tmp/mcp-config.json

          echo "MCP config created:"
          cat /tmp/mcp-config.json

      - name: Run Claude Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Create the code review prompt
          cat > /tmp/code-review-prompt.md << 'PROMPT_EOF'
          Provide a code review for PR #$PR_NUMBER in $REPO.

          Follow these steps precisely:

          1. Launch a haiku agent to check if any of the following are true:
             - The pull request is closed
             - The pull request is a draft
             - The pull request does not need code review (e.g. automated PR, trivial change that is obviously correct)
             - Claude has already commented on this PR (use `gh api repos/OWNER/REPO/issues/PR_NUMBER/comments` and check for comments from your bot specifically)

             If any condition is true, stop and do not proceed.

          Note: Still review Claude generated PR's.

          2. Launch a haiku agent to return a list of file paths (not their contents) for all relevant CLAUDE.md files including:
             - The root CLAUDE.md file, if it exists
             - Any CLAUDE.md files in directories containing files modified by the pull request

          3. Launch a sonnet agent to view the pull request and return a summary of the changes

          4. Launch 4 agents in parallel to independently review the changes. Each agent should return the list of issues, where each issue includes a description and the reason it was flagged (e.g. "CLAUDE.md adherence", "bug"). The agents should do the following:

             Agents 1 + 2: CLAUDE.md compliance sonnet agents
             Audit changes for CLAUDE.md compliance in parallel. Note: When evaluating CLAUDE.md compliance for a file, you should only consider CLAUDE.md files that share a file path with the file or parents.

             Agent 3: Opus bug agent (parallel subagent with agent 4)
             Scan for obvious bugs. Focus only on the diff itself without reading extra context. Flag only significant bugs; ignore nitpicks and likely false positives. Do not flag issues that you cannot validate without looking at context outside of the git diff.

             Agent 4: Opus bug agent (parallel subagent with agent 3)
             Look for problems that exist in the introduced code. This could be security issues, incorrect logic, etc. Only look for issues that fall within the changed code.

             **CRITICAL: We only want HIGH SIGNAL issues.** This means:
             - Objective bugs that will cause incorrect behavior at runtime
             - Clear, unambiguous CLAUDE.md violations where you can quote the exact rule being broken

             We do NOT want:
             - Subjective concerns or "suggestions"
             - Style preferences not explicitly required by CLAUDE.md
             - Potential issues that "might" be problems
             - Anything requiring interpretation or judgment calls

             If you are not certain an issue is real, do not flag it. False positives erode trust and waste reviewer time.

             In addition to the above, each subagent should be told the PR title and description. This will help provide context regarding the author's intent.

          5. For each issue found in the previous step by agents 3 and 4, launch parallel subagents to validate the issue. These subagents should get the PR title and description along with a description of the issue. The agent's job is to review the issue to validate that the stated issue is truly an issue with high confidence. Use Opus subagents for bugs and logic issues, and sonnet agents for CLAUDE.md violations.

          6. Filter out any issues that were not validated in step 5. This step will give us our list of high signal issues for our review.

          7. If issues were found, skip to step 8 to post inline comments directly.

             If NO issues were found, post a summary comment using `gh pr comment`:
             "## Code review\n\nNo issues found. Checked for bugs and CLAUDE.md compliance."

          8. Post inline comments for each issue using `mcp__github_inline_comment__create_inline_comment`:
             - `path`: the file path
             - `line` (and `startLine` for ranges): select the buggy lines so the user sees them
             - `body`: Brief description of the issue (no "Bug:" prefix). For small fixes (up to 5 lines changed), include a committable suggestion:
               ```suggestion
               corrected code here
               ```

               **Suggestions must be COMPLETE.** If a fix requires additional changes elsewhere, do NOT use a suggestion block.

               For larger fixes (6+ lines, structural changes, or changes spanning multiple locations), do NOT use suggestion blocks. Instead:
               1. Describe what the issue is
               2. Explain the suggested fix at a high level
               3. Include a copyable prompt for Claude Code that the user can use to fix the issue

             **IMPORTANT: Only post ONE comment per unique issue. Do not post duplicate comments.**

          Use this list when evaluating issues (these are false positives, do NOT flag):
          - Pre-existing issues
          - Something that appears to be a bug but is actually correct
          - Pedantic nitpicks that a senior engineer would not flag
          - Issues that a linter will catch
          - General code quality concerns unless explicitly required in CLAUDE.md
          - Issues mentioned in CLAUDE.md but explicitly silenced in the code

          Notes:
          - Use gh CLI to interact with GitHub. Do not use web fetch.
          - Create a todo list before starting.
          - You must cite and link each issue in inline comments.
          - When linking to code in inline comments, use format: https://github.com/OWNER/REPO/blob/FULL_SHA/path/file.ts#L10-L15
          PROMPT_EOF

          # Substitute environment variables in the prompt
          envsubst < /tmp/code-review-prompt.md > /tmp/code-review-prompt-final.md

          claude --dangerously-skip-permissions --print \
            --mcp-config /tmp/mcp-config.json \
            --allowedTools "Task,Read,Glob,Grep,Bash(gh:*),Bash(git:*),mcp__github_inline_comment__create_inline_comment,TodoWrite" \
            --output-format stream-json \
            -p "$(cat /tmp/code-review-prompt-final.md)"
